--------------------------------------------------------
--------------------------------------------------------
----------------
---------------- I'm so sorry who ever is reading this code, I literately cannot make menus for shit.
----------------
--------------------------------------------------------
--------------------------------------------------------

-- todo: add a hook similar to the OnBanListchanged hook
-- yes

local panel = {}

--local psizew, psizeh = 450, 500
local psizew, psizeh = 550, 600
local boxpaddingw, boxpaddingh = 5, 5
function panel:Init()
	self:SetFocusTopLevel( true )
	self:SetSize( psizew, psizeh )
	self:SetPos( 400, 40 )
	self:MakePopup()
	
	self.Padding = self:Add("DPanel")
	self.Padding:SetWide( psizew )
	self.Padding:Dock( TOP )
	self.Padding.Paint = function() end
	
	self.MenuTitle = self:Add("DPanel")
	self.MenuTitle:SetWide( sizew )
	self.MenuTitle:SetTall( self.MenuTitle:GetTall() )
	self.MenuTitle:Dock( TOP )
	self.MenuTitle.Paint = function( pnl, w, h )
	end
	
	self.MenuTitle.Label = self.MenuTitle:Add( "DLabel" )
	self.MenuTitle.Label:SetText( "Modify Groups" )
	self.MenuTitle.Label:SetTextColor( Color( 0, 36, 60, 255 ) )
	self.MenuTitle.Label:Dock( FILL )
	self.MenuTitle.Label:SetFont( "anus_BigTitle" )
	self.MenuTitle.Label:SetContentAlignment( 2 )
	self.MenuTitle.Label:SizeToContents()
	
	self.MenuTitle.Div = self:Add("DPanel")
	self.MenuTitle.Div:SetWide( sizew )
	self.MenuTitle.Div:Dock( TOP )
	self.MenuTitle.Div.Paint = function( pnl, w, h )
		surface.SetDrawColor( Color( 0, 60, 100, 255 ) )--Color( 0, 161, 255, 255 ) )--Color( 106, 102, 124, 255 ) )
			-- psizeh * 0.01
		surface.DrawRect( boxpaddingw, psizeh * 0.031, psizew - 10, psizeh)
	end
	
	self.Side = self:Add("DPanel")
	self.Side:SetWide( psizew * 0.3 )
	self.Side:Dock( LEFT )
	self.Side.Paint = function() end
	
	self.Side.CloseButton = self.Side:Add("DButton")
	self.Side.CloseButton:SetText( "" )
	self.Side.CloseButton:SetWide( psisew )
	self.Side.CloseButton:SetTall( psizeh * 0.13 )
	self.Side.CloseButton:Dock( TOP )
	self.Side.CloseButton.DoClick = function() self:Remove() end
	local titlelabel = self.MenuTitle.Label:GetTall()
	local closebuttonx,closebuttony = self.Side.CloseButton:GetPos()
	local closebuttonsizex, closebuttonsizey = self.Side.CloseButton:GetSize()
	surface.SetFont("anus_SmallTitle")
	local closetextw,closetexth = surface.GetTextSize( "CLOSE" )
	self.Side.CloseButton.Paint = function( pnl, w, h )
		draw.RoundedBox( 0, boxpaddingw, 0, w, (psizeh - boxpaddingh) - (titlelabel * 4), Color( 195, 70, 70, 255 ) )
		draw.DrawText( "CLOSE", "anus_SmallTitle", (closebuttonsizex / 2) + closetextw + (boxpaddingw * 4) + 1, (h / 2) - (closetexth / 2), Color( 255, 255, 255, 255 ), TEXT_ALIGN_CENTER )
	end
	
	self.Side.Panel = self.Side:Add("DPanel")
	self.Side.Panel:SetTall( psizeh * 0.695 - boxpaddingh)
	self.Side.Panel:Dock( TOP )
	self.Side.Panel:SetPos( 50, 100 )
	self.Side.Panel.Paint = function() end
	
	local combobox_offset = 5
	
	self.Side.Panel.Groups = self.Side.Panel:Add("DComboBox")
	self.Side.Panel.Groups:SetPos( boxpaddingw, combobox_offset )
		-- todo: no hardcoding?
	self.Side.Panel.Groups:SetWide( 160 )
	self.Side.Panel.Groups:SetValue( "user" )
	--self.Side.Panel.Groups:Dock( TOP )
	for groups,v in SortedPairsByMemberValue( anus.Groups, "id", false ) do
		self.Side.Panel.Groups:AddChoice( groups )
		self.Side.Panel.Groups.OnSelect = function( pnl, index, value )
			self.Side.Panel.PlayerList:Clear()
			if anus.Users and anus.Users[ value ] then
				for k,v in pairs(anus.Users[ value ]) do
					self.Side.Panel.PlayerList:AddLine( k, v.name )
				end
			elseif value == "user" then
				for k,v in pairs(player.GetAll()) do
					if not LocalPlayer().PlayerInfo or not LocalPlayer().PlayerInfo[ v ] then
						self.Side.Panel.PlayerList:AddLine( v:SteamID(), v:Nick() )
					end
				end
			end
					
		end
	end
	self.Side.Panel.Groups:AddChoice( "Manage Groups" )
	
	net.Start("anus_requestusers")
	net.SendToServer()
	
	self.Side.Panel.PlayerList = self.Side.Panel:Add("DListView")
	self.Side.Panel.PlayerList:SetSize( self.Side:GetWide() - boxpaddingw, psizeh * 0.5 )
		-- 22 is combo box height
	self.Side.Panel.PlayerList:SetPos( boxpaddingw, 22 + combobox_offset )
		-- maybe make it true later.
	self.Side.Panel.PlayerList:SetMultiSelect( false )
	self.Side.Panel.PlayerList:AddColumn( "Player SteamID" )
	self.Side.Panel.PlayerList.Columns[ 1 ]:SetFixedWidth( 1 )
	self.Side.Panel.PlayerList:AddColumn( "Players in Group" )
	
	self.Side.Panel.ChangeGroup = self.Side.Panel:Add("DButton")
	
	hook.Add("OnPlayerGroupsChanged", "anus_PlayerInGroupsRefresh", function()
		if not anus_GroupsMenu or not IsValid(anus_GroupsMenu) then return end

		self.Side.Panel.PlayerList:Clear()
	
			-- loop through current group selected
		if self.Side.Panel.Groups:GetValue() == "user" then
			for k,v in pairs(player.GetAll()) do
				if not LocalPlayer().PlayerInfo or not LocalPlayer().PlayerInfo[ v ] then
					self.Side.Panel.PlayerList:AddLine( v:SteamID(), v:Nick() )
				end
			end
		else
			if anus.Users and anus.Users[ self.Side.Panel.Groups:GetValue() ] then
				for k,v in pairs(anus.Users[ self.Side.Panel.Groups:GetValue() ]) do
					self.Side.Panel.PlayerList:AddLine( k, v.name )
				end
			end
		end
			
			
			
			
		--[[for k,v in pairs(player.GetAll()) do
				-- this first part probably isnt needed anymore. oh well.
			if LocalPlayer().PlayerInfo and LocalPlayer().PlayerInfo[ v ] and LocalPlayer().PlayerInfo[ v ].group == "user" then
				self.Side.Panel.PlayerList:AddLine( v:SteamID(), v:Nick() )
			elseif not LocalPlayer().PlayerInfo or not LocalPlayer().PlayerInfo[ v ] then
				self.Side.Panel.PlayerList:AddLine( v:SteamID(), v:Nick() )
			end
		end]]
		self.Side.Panel.PlayerList.OnRowRightClick = function( parent, lineid, line )
			local playerlist = DermaMenu()
			playerlist:AddOption( "Close", function() end )
			playerlist:AddOption( "Update Name", function() line:SetValue( 2, steamworks.GetPlayerName( util.SteamIDTo64( line:GetValue( 1 ) ) ) ) end )
			playerlist:AddOption( "View Promotion Date", function() LocalPlayer():ChatPrint( line:GetValue(2) .. " was set to " .. self.Side.Panel.Groups:GetValue() .. " on ................" ) end )
			playerlist:AddOption( "View Profile", function() gui.OpenURL("http://steamcommunity.com/profiles/" .. util.SteamIDTo64( line:GetValue( 1 ) )) end )
				-- might be useful idk
			playerlist:AddOption( "Copy SteamID", function() SetClipboardText( line:GetValue( 1 ) ) end )
				
			playerlist:Open()
		end

		self.Side.Panel.ChangeGroup:SetText( "Change" )
		local listx,listy = self.Side.Panel.PlayerList:GetPos()
		local listw,listh = self.Side.Panel.PlayerList:GetSize()
		self.Side.Panel.ChangeGroup:SetPos( boxpaddingw, listh + listy )
		self.Side.Panel.ChangeGroup:SetSize( self.Side:GetWide() - boxpaddingw, 20 )
		self.Side.Panel.ChangeGroup.DoClick = function()
			if not self.Side.Panel.PlayerList:GetSelectedLine() then print("grrr") return end
			local playerline = self.Side.Panel.PlayerList:GetLine( self.Side.Panel.PlayerList:GetSelectedLine() )
			
			local groupslist = DermaMenu()
			groupslist:AddOption( "Close", function() end )
			groupslist:AddSpacer()
			for k,v in SortedPairsByMemberValue( anus.Groups, "id", false ) do
				groupslist:AddOption( k, function()
					local found = false
					for _,v in pairs(player.GetAll()) do
						if v:SteamID() == playerline:GetValue( 1 ) then
							print("player is in the server - anus_adduser")
							RunConsoleCommand("anus_adduser", tostring(playerline:GetValue(1)), k)
						
							found = true
							break
						end
					end
					
					if not found then
						print("player isnt in server - anus_adduserid")
						RunConsoleCommand("anus_adduserid", tostring(playerline:GetValue(1)), k)
					end
				end )
				
			end
			
			groupslist:Open()
		end
	end)
	
	self.Side.Panel.Apply = self.Side.Panel:Add("DButton")
	self.Side.Panel.Apply:SetText( "Apply Changes" )
	local changex,changey = self.Side.Panel.ChangeGroup:GetPos()
	self.Side.Panel.Apply:SetPos( boxpaddingw, self.Side.Panel:GetTall() - 39 )
	self.Side.Panel.Apply:SetSize( self.Side:GetWide() - boxpaddingw, 40 )
		

end

function panel:Paint()
	draw.RoundedBox( 6, 0, 0, psizew, psizeh - 31, Color( 0, 60, 100, 255 ) )--Color( 106, 102, 124, 220 ) )
	draw.RoundedBox( 0, boxpaddingw, boxpaddingh, psizew - 10 , psizeh - 42, Color( 240, 240, 240, 220 ) )
end

vgui.Register( "anus_groupsmenu", panel )